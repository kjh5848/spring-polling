<!doctype html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Polling Chat</title>
</head>

<body>

    <h1>Polling Chat</h1>
    <hr>

    <div>
        <input id="sender" placeholder="이름">
        <input id="message" placeholder="메시지">
        <button onclick="sendMessage()">전송</button>
    </div>

    <ul id="chat-box"></ul>

    <script>
        // 마지막으로 받은 메시지의 id
        let lastId = 0;

        // 신규 메시지 불러오기 (폴링)
        async function loadNewMessages() {
            try {
                const res = await fetch(`/api/chat?lastId=${lastId}`);
                if (!res.ok) {
                    console.error("메시지 조회 실패", res.status);
                    return;
                }

                const data = await res.json();
                const box = document.getElementById("chat-box");

                data.forEach(chat => {
                    // 마지막 id 갱신
                    lastId = chat.id;

                    const li = document.createElement("li");
                    li.innerHTML = `<b>${chat.sender}</b>: ${chat.message}`;
                    box.appendChild(li);
                });

                // 최신 메시지가 보이도록 스크롤 내리기
                box.scrollTop = box.scrollHeight;
            } catch (e) {
                console.error("loadNewMessages 에러:", e);
            }
        }

        // 메시지 전송
        async function sendMessage() {
            const senderInput = document.getElementById("sender");
            const messageInput = document.getElementById("message");

            const sender = senderInput.value.trim();
            const message = messageInput.value.trim();

            if (!sender || !message) {
                alert("이름과 메시지를 입력하세요.");
                return;
            }

            try {
                await fetch("/api/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sender, message })
                });

                // 입력창 비우기
                messageInput.value = "";
                messageInput.focus();
            } catch (e) {
                console.error("sendMessage 에러:", e);
            }
        }

        // 최초 1번 호출 (처음 들어왔을 때 기존 메시지 로딩)
        loadNewMessages();

        // 이후 2초마다 신규 메시지만 폴링
        setInterval(loadNewMessages, 2000);
    </script>

</body>

</html>