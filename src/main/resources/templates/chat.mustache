<!doctype html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Polling Chat</title>
</head>

<body>

    <h1>Polling Chat</h1>
    <hr>

    <div>
        <input id="sender" placeholder="이름">
        <input id="message" placeholder="메시지">
        <button onclick="sendMessage()">전송</button>
    </div>

    <ul id="chat-box"></ul>

    <script>
        // 전체 메시지를 매번 새로 불러오기 (폴링)
        async function loadMessages() {
            const res = await fetch("/api/chat");
            if (!res.ok) {
                console.error("메시지 조회 실패", res.status);
                return;
            }

            const data = await res.json();
            const box = document.getElementById("chat-box");

            // 최신 목록으로 교체
            box.innerHTML = "";

            data.forEach(chat => {
                const li = document.createElement("li");
                li.innerHTML = `<b>${chat.sender}</b>: ${chat.message}`;
                box.appendChild(li);
            });
        }

        // 메시지 전송
        async function sendMessage() {
            const senderInput = document.getElementById("sender");
            const messageInput = document.getElementById("message");

            const sender = senderInput.value.trim();
            const message = messageInput.value.trim();

            if (!sender || !message) {
                alert("이름과 메시지를 입력하세요.");
                return;
            }

            await fetch("/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sender, message })
            });

            // 입력창 비우기
            messageInput.value = "";
            messageInput.focus();

            // 전송 후 최신 목록 재조회
            loadMessages();
        }

        // 최초 1번 호출 (처음 들어왔을 때 기존 메시지 로딩)
        loadMessages();

        // 이후 2초마다 전체 목록 재조회
        setInterval(loadMessages, 2000);
    </script>

</body>

</html>
