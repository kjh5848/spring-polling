<!doctype html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Polling Chat</title>
</head>

<body>

    <h1>Polling Chat</h1>
    <hr>

    <div>
        <input id="message" placeholder="메시지">
        <button onclick="sendMessage()">전송</button>
    </div>

    <ul id="chat-box"></ul>

    <script>
        //  클라이언트 폴링: 일정 주기로 /chats에 GET 요청하여 전체 메시지 재로딩
        async function loadMessages() {
            const res = await fetch("/chats");

            const data = await res.json();
            const box = document.getElementById("chat-box");

            // 기존 메시지 전체 삭제
            box.innerHTML = "";

            data.forEach(chat => {
                const li = document.createElement("li");
                li.innerText = chat.message;
                box.appendChild(li);
            });
        }
        //  메시지 전송: 저장 후 바로 (2) 재호출
        async function sendMessage() {
            const messageInput = document.getElementById("message");

            const message = messageInput.value.trim();

            await fetch("/chats", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message })
            });

            // 입력창 비우기
            messageInput.value = "";
            messageInput.focus();

            // 전송 후 최신 목록 재조회
            loadMessages();
        }

        // 최초 1회 호출: 초기 입장 시 기존 메시지 로딩
        loadMessages();

        // 이후 2초마다 반복 폴링
        setInterval(loadMessages, 2000);
    </script>

</body>

</html>
